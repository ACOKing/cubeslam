(function(){function t(e){return t.enabled(e)?function(n){var r=new Date,i=r-(t[e]||r);t[e]=r,n=e+" "+n+" +"+t.humanize(i),window.console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}:function(){}}function n(t,r){var i=n.resolve(t),s=n.modules[i];if(!s)throw new Error('failed to require "'+t+'" from '+r);return s.exports||(s.exports={},s.call(s.exports,s,s.exports,n.relative(i),e)),s.exports}var e=this;t.names=[],t.skips=[],t.enable=function(e){localStorage.debug=e;var n=(e||"").split(/[\s,]+/),r=n.length;for(var i=0;i<r;i++)e=n[i].replace("*",".*?"),e[0]==="-"?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$"))},t.disable=function(){t.enable("")},t.humanize=function(e){var t=1e3,n=6e4,r=60*n;return e>=r?(e/r).toFixed(1)+"h":e>=n?(e/n).toFixed(1)+"m":e>=t?(e/t|0)+"s":e+"ms"},t.enabled=function(e){for(var n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(var n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},window.localStorage&&t.enable(localStorage.debug),n.modules={},n.resolve=function(e){var t=e,r=e+".js",i=e+"/index.js";return n.modules[r]&&r||n.modules[i]&&i||t},n.register=function(e,t){n.modules[e]=t},n.relative=function(e){return function(r){if("debug"==r)return t;if("."!=r.charAt(0))return n(r);var i=e.split("/"),s=r.split("/");i.pop();for(var o=0;o<s.length;o++){var u=s[o];".."==u?i.pop():"."!=u&&i.push(u)}return n(i.join("/"),e)}},n.register("app.js",function(e,t,n,r){function o(e){this.receiver=e,this.latency=100,this.onmessage=function(){},this.send=function(e){var t=-5+Math.random()*10;setTimeout(function(){this.receiver.onmessage(e)}.bind(this),this.latency+t)}.bind(this)}var i=n("./game"),s=n("./simulator"),u={create:function(){var e=new o,t=new o;e.receiver=t,t.receiver=e,this.host=new s(document.getElementById("host"),document.getElementById("host-form")),this.host.host=!0,this.host.channel=e,this.host.create(),this.guest=new s(document.getElementById("guest"),document.getElementById("guest-form")),this.guest.host=!1,this.guest.channel=t,this.guest.create()},destroy:function(){this.host.destroy(),this.guest.destroy(),delete this.host,delete this.guest},controls:function(e){this.host.controls(e),this.guest.controls(e)},update:function(e,t){this.host.update(e,t),this.guest.update(e,t)},render:function(e){this.host.render(e),this.guest.render(e)}};(new i).pushState(u).run()}),n.register("body.js",function(e,t,n,r){function s(e,t,n){var r=n/7.5,s=r*3/4,u=new i(e+o(-5,5),t+o(-5,5),4),a=new i(e+o(-5,5),t+o(-5,5),26);u.attachTo(a,5/4*r,1,n*2);var f=new i(e+o(-5,5),t+o(-5,5),2),l=new i(e+o(-5,5),t+o(-5,5),2);f.attachTo(a,r*3/2,1,n*2),l.attachTo(a,r*3/2,1,n*2);var c=new i(e+o(-5,5),t+o(-5,5),2),h=new i(e+o(-5,5),t+o(-5,5),2);c.attachTo(f,r*2,1,n*2),h.attachTo(l,r*2,1,n*2);var p=new i(e+o(-5,5),t+o(-5,5),15);p.attachTo(a,r*3.5,.8,n*2),p.attachTo(u,r*4.75,.02,n*2).hidden=!0;var d=new i(e+o(-5,5),t+o(-5,5),10),v=new i(e+o(-5,5),t+o(-5,5),10);d.attachTo(p,r*2,1,n*2),v.attachTo(p,r*2,1,n*2);var m=new i(e+o(-5,5),t+o(-5,5),5),g=new i(e+o(-5,5),t+o(-5,5),5);m.attachTo(d,r*2,1,n*2),g.attachTo(v,r*2,1,n*2),m.attachTo(a,r*7.5,.001,n*2).hidden=!0,g.attachTo(a,r*7.5,.001,n*2).hidden=!0,this.head=u,this.shoulder=a,this.pelvis=p,this.elbowLeft=f,this.elbowRight=l,this.handLeft=c,this.handRight=h,this.kneeLeft=d,this.kneeRight=v,this.footLeft=m,this.footRight=g}function o(e,t){return e+Math.random()*(t-e)}var i=n("./point-mass");e.exports=s,s.prototype.setBounds=function(e){this.head.bounds=e,this.shoulder.bounds=e,this.pelvis.bounds=e,this.elbowLeft.bounds=e,this.elbowRight.bounds=e,this.handLeft.bounds=e,this.handRight.bounds=e,this.kneeLeft.bounds=e,this.kneeRight.bounds=e,this.footLeft.bounds=e,this.footRight.bounds=e},s.prototype.addToWorld=function(e){e.push(this.head),e.push(this.shoulder),e.push(this.pelvis),e.push(this.elbowLeft),e.push(this.elbowRight),e.push(this.handLeft),e.push(this.handRight),e.push(this.kneeLeft),e.push(this.kneeRight),e.push(this.footLeft),e.push(this.footRight)},s.prototype.removeFromWorld=function(e){function t(t){var n=e.indexOf(t);~n&&e.splice(n,1)}t(this.head),t(this.shoulder),t(this.pelvis),t(this.elbowLeft),t(this.elbowRight),t(this.handLeft),t(this.handRight),t(this.kneeLeft),t(this.kneeRight),t(this.footLeft),t(this.footRight)}}),n.register("game.js",function(e,t,n,r){function u(){this.inputs=new s,this.states=[],this.current=null}var i=n("./request-animation-frame"),s=n("./inputs"),o=n("debug")("game");e.exports=u,u.prototype.pushState=function(e){o("pushState");if(typeof e!="object")throw new Error("invalid state. must be object.");return this.states.push(e),this.current=e,e.game=this,e.create&&e.create(),this},u.prototype.popState=function(){o("popState");var e=this.current;return e.destroy&&e.destroy(),delete e.game,this.current=this.states.pop(),this},u.prototype.isState=function(e){return e===this.current},u.prototype.switchState=function(e){o("switchState"),this.popState().pushState(e)},u.prototype.run=function(){function u(){i(u);var a=Date.now()/1e3,f=a-n,l=.25;n=a;var c=s.current;if(!c){console.error("no more states. done!"),o("stop");return}f>l&&(f=l),r+=f;while(r>=t)c.game&&c.controls&&c.controls(s.inputs),c.game&&c.update&&c.update(t,e),e+=t,r-=t;c.game&&c.render&&c.render(r/t)}if(!this.current)throw new Error("no current state. must pushState() first.");o("run");var e=0,t=1/60,n=0,r=0,s=this;return u(),this}}),n.register("inputs.js",function(e,t,n,r){function s(){this.mouse=new i,this.mouse.last=new i,this.touches=[],this.keyboard={},this.forms=[];var e=this;if(document){document.addEventListener("mousedown",function(t){t.preventDefault(),e.onmousedown(t)},!1),document.addEventListener("mousemove",function(t){t.preventDefault(),e.onmousemove(t)},!1),document.addEventListener("mouseup",function(t){t.preventDefault(),e.onmouseup(t)},!1),this.form={};for(var t=0;t<document.forms.length;t++){var n=document.forms[t];for(var r=0;r<n.elements.length;r++){var s=n.elements[r];console.log(s.nodeName,s.type,s.name);switch(s.nodeName.toLowerCase()){case"button":s.addEventListener("mousedown",function(t){t.stopImmediatePropagation(),t.preventDefault(),e.onbuttondown(t,s)},!1),s.addEventListener("mouseup",function(t){t.stopImmediatePropagation(),t.preventDefault(),e.onbuttonup(t,s)},!1)}}}}}var i=n("./point");e.exports=s,s.prototype.pressed=function(e){if(/(\w+) (\w+)/.exec(e)){var t=RegExp.$1,n=RegExp.$2;return this[t][n]}},s.prototype.onbuttondown=function(e,t){this.form[t.name]=!0},s.prototype.onbuttonup=function(e,t){this.form[t.name]=!1},s.prototype.onmousedown=function(e){this.mouse.down=!0,this.mouse.up=!1},s.prototype.onmouseup=function(e){this.mouse.down=!1,this.mouse.up=!0},s.prototype.onmousemove=function(e){this.mouse.last.set(this.mouse),this.mouse.set(e.offsetX,e.offsetY)},s.prototype.reset=function(){this.mouse.up=!1,this.mouse.down=!1;for(var e in this.keyboard)delete this.keyboard[e]}}),n.register("link.js",function(e,t,n,r){function s(e,t,n,r,i){if(!e)throw new Error("invalid point mass a");if(!t)throw new Error("invalid point mass b");if(typeof n!="number")throw new Error("resting difference must be a number");if(typeof r!="number")throw new Error("stiffness must be a number");if(typeof i!="number")throw new Error("tear sensitivity must be a number");this.a=e,this.b=t,this.restingDistance=n,this.stiffness=r,this.tearSensitivity=i}var i=n("./point");e.exports=s,s.prototype={solve:function(){var e=i.diff(this.b.current,this.a.current),t=e.length,n=(this.restingDistance-t)/t;t>this.tearSensitivity&&this.a.removeLink(this);var r=1/this.a.mass,s=1/this.b.mass,o=r/(r+s)*this.stiffness,u=this.stiffness-o;this.a.current.add(e.x*o*n,e.y*o*n),this.b.current.sub(e.x*u*n,e.y*u*n)}}}),n.register("physics.js",function(e,t,n,r){function s(){this.frame=0,this.direction=1,this.pointMasses=[],this.constraintAccuracy=3}var i=n("debug")("physics");e.exports=s,s.prototype={"goto":function(e){i("goto",e);var t=this.direction;this.direction=this.frame>e?-1:1;while(this.frame!=e)this.update(1/60);this.direction=t},reverse:function(){i("reverse");for(var e=0;e<this.pointMasses.length;e++){var t=this.pointMasses[e],n=t.current.x,r=t.current.y;t.current.set(t.previous),t.previous.set(n,r)}this.direction=-this.direction},update:function(e){for(var t=0;t<this.constraintAccuracy;t++)for(var n=0;n<this.pointMasses.length;n++)this.pointMasses[n].solveConstraints();for(var t=0;t<this.pointMasses.length;t++)this.pointMasses[t].update(e);this.frame+=this.direction}}}),n.register("point-mass.js",function(e,t,n,r){function o(e,t,n){this.previous=new i(e,t),this.current=new i(e,t),this.acceleration=new i,this.velocity=new i,this.mass=n||1,this.damping=1,this.links=[],this.bounds=null,this._pinned=null,this._next=new i}var i=n("./point"),s=n("./link");e.exports=o,o.prototype={update:function(e){var t=e*e;this.velocity.set(this.current.x-this.previous.x,this.current.y-this.previous.y),this.damping!=1&&this.velocity.mul(this.damping),this._next.set(this.current.x+this.velocity.x+.5*this.acceleration.x*t,this.current.y+this.velocity.y+.5*this.acceleration.y*t),this.previous.set(this.current),this.current.set(this._next),this.acceleration.reset()},solveConstraints:function(){for(var e=0;e<this.links.length;e++)this.links[e].solve();if(this.bounds&&!this.bounds.within(this.current)){var t=this.bounds.intersectsWithLine(this.previous,this.current);if(!t)return;if(t.length>1)return console.warn("woops, multiple intersections. FIXME!",t),this.bounds.restrain(this.current);var n=t[0],r=n.normal,s=this.velocity.dot(r)*2,o=this.velocity.clone().sub(r.mul(s)).normalize(),u=o.clone().mul(-i.distance(n,this.previous)),a=o.clone().mul(+i.distance(n,this.current));this.previous.set(u).add(n),this.current.set(a).add(n)}this._pinned&&this.current.set(this._pinned)},attachTo:function(e,t,n,r){if(this===e)throw new Error("cannot attach to itself");if(e instanceof o){var i=new s(this,e,t,n,r);return this.links.push(i),i}throw new Error("must attach to PointMass")},removeLink:function(e){var t=this.links.indexOf(e);return this.links.splice(t,1),e},applyForce:function(e,t){var n=1/this.mass;this.acceleration.add(e*n,t*n)},pinTo:function(e,t){this._pinned?this._pinned.set(e,t):this._pinned=new i(e,t)}}}),n.register("point.js",function(e,t,n,r){function i(e,t){if(!(this instanceof i))return new i(e,t);typeof e=="object"&&(t=e.y,e=e.x),this.x=e||0,this.y=t||0}e.exports=i,i.prototype={set:function(e,t){if(e instanceof i)this.x=e.x,this.y=e.y;else if(arguments.length==1)this.x=e,this.y=e;else{if(arguments.length!=2)throw new Error("invalid arguments");this.x=e,this.y=t}return this},add:function(e,t){if(e instanceof i)this.x+=e.x,this.y+=e.y;else if(arguments.length==1)this.x+=e,this.y+=e;else{if(arguments.length!=2)throw new Error("invalid arguments");this.x+=e,this.y+=t}return this},sub:function(e,t){if(e instanceof i)this.x-=e.x,this.y-=e.y;else if(arguments.length==1)this.x-=e,this.y-=e;else{if(arguments.length!=2)throw new Error("invalid arguments");this.x-=e,this.y-=t}return this},mul:function(e,t){if(e instanceof i)this.x*=e.x,this.y*=e.y;else if(arguments.length==1)this.x*=e,this.y*=e;else{if(arguments.length!=2)throw new Error("invalid arguments");this.x*=e,this.y*=t}return this},div:function(e,t){if(e instanceof i)this.x/=e.x,this.y/=e.y;else if(arguments.length==1)this.x/=e,this.y/=e;else{if(arguments.length!=2)throw new Error("invalid arguments");this.x/=e,this.y/=t}return this},abs:function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},dot:function(e){return this.x*e.x+this.y*e.y},get length(){return Math.sqrt(this.dot(this))},reset:function(){return this.x=0,this.y=0,this},normalize:function(){var e=this.length;return e&&(this.x/=e,this.y/=e),this},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},clone:function(){return new i(this.x,this.y)},copy:function(e){return e&&(this.x=e.x||this.x,this.y=e.y||this.y),this},validate:function(){if(typeof this.x!="number")throw new Error("invalid x:"+this.x);if(typeof this.y!="number")throw new Error("invalid y:"+this.y);return this},toString:function(){return"("+this.x+","+this.y+")"}},i.prototype.multiply=i.prototype.mul,i.prototype.subtract=i.prototype.sub,i.prototype.divide=i.prototype.div,i.prototype.interpolate=i.prototype.lerp,i.polar=function(e,t){var n=Math.PI/180;return new i(Math.sin(e*n)*t,Math.cos(e*n)*t)},i.distance=function(e,t){return i.diff(e,t).length},i.diff=function(e,t){return new i(t.x-e.x,t.y-e.y)};var s=["add","sub","mul","div","dot","abs","lerp"];s.forEach(function(e){i[e]=function(t){var n=t.clone(),r=[].slice.call(arguments,1);return n[e].apply(n,r)}})}),n.register("rect.js",function(e,t,n,r){function s(e,t,n,r){this.t=e,this.r=t,this.b=n,this.l=r}function o(e,t,n,r){var s,o=(r.x-n.x)*(e.y-n.y)-(r.y-n.y)*(e.x-n.x),u=(t.x-e.x)*(e.y-n.y)-(t.y-e.y)*(e.x-n.x),a=(r.y-n.y)*(t.x-e.x)-(r.x-n.x)*(t.y-e.y);if(a!=0){var f=o/a,l=u/a;if(0<=f&&f<=1&&0<=l&&l<=1){var c=new i(e.x+f*(t.x-e.x),e.y+f*(t.y-e.y)),h=t.x-e.x,p=t.y-e.y;return c.normal=(new i(-p,h)).normalize(),c}return null}return o==0||u==0?null:null}var i=n("./point");e.exports=s,s.prototype={within:function(e){return e.x>this.l&&e.x<this.r&&e.y>this.t&&e.y<this.b},restrain:function(e){e.y<this.t&&(e.y=2*this.t-e.y),e.y>this.b&&(e.y=2*this.b-e.y),e.x<this.l&&(e.x=2*this.l-e.x),e.x>this.r&&(e.x=2*this.r-e.x)},intersectsWithLine:function(e,t){var n=new i(this.l,this.t),r=new i(this.r,this.t),s=new i(this.l,this.b),u=new i(this.r,this.b),a,f=[];return a=o(n,r,e,t),a&&f.push(a),a=o(r,u,e,t),a&&f.push(a),a=o(u,s,e,t),a&&f.push(a),a=o(s,n,e,t),a&&f.push(a),f.length?f:null}}}),n.register("renderer.js",function(e,t,n,r){function i(e){this.pointMasses=[],this.forces=[],this.canvas=e,this.context=e.getContext("2d"),this.stats={forces:0,pointMass:0,links:0}}e.exports=i,i.prototype={drawForce:function(e){var t=this.context.createRadialGradient(e.x,e.y,0,e.x,e.y,e.mass/2);e.type=="attract"?(t.addColorStop(0,"rgba(1,0,0,1)"),t.addColorStop(1,"rgba(1,0,0,0)")):e.type=="repell"&&(t.addColorStop(0,"rgba(0,1,0,1)"),t.addColorStop(1,"rgba(0,1,0,0)")),this.context.fillStyle=t,this.context.fillRect(e.x-e.mass/2,e.y-e.mass/2,e.mass,e.mass),this.stats.forces++},drawPointMass:function(e){if(e.links.length)for(var t=0,n=e.links.length;t<n;t++)this.drawLink(e.links[t]);else this.context.rect(e.current.x-1,e.current.y-1,2,2);this.stats.pointMass++},drawLink:function(e){e.hidden||(this.context.moveTo(e.a.current.x,e.a.current.y),this.context.lineTo(e.b.current.x,e.b.current.y),this.stats.links++)},clear:function(){this.canvas.width=this.canvas.width},render:function(e){this.stats.forces=0,this.stats.pointMass=0,this.stats.links=0;for(var t=0,n=this.forces.length;t<n;t++)this.drawForce(this.forces[t]);this.context.strokeStyle="#000";for(var t=0,n=this.pointMasses.length;t<n;t++)this.drawPointMass(this.pointMasses[t]);this.context.stroke()}}}),n.register("request-animation-frame.js",function(e,t,n,r){var i=function(e){setTimeout(e,1e3/60)};e.exports=typeof window!="undefined"?window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||i:i}),n.register("simulator.js",function(e,t,n,r){function l(e,t){this.form=t,this.width=e.width,this.height=e.height,this.bounds=new a(1,this.width-1,this.height-1,1),this.physics=new i,this.renderer=new s(e)}function c(e,t,n){var r=u.diff(n,e),i=u.diff(t,e),s=i.x*i.x+i.y*i.y,o=-r.x*i.x+ -r.y*i.y;return o<0||o>s?(i.set(t.x-n.x,t.y-n.y),Math.min(r.x*r.x+r.y*r.y,i.x*i.x+i.y*i.y)):(o=i.x*r.y-i.y*r.x,o*o/s)}function h(e,t,n){if(!e)throw new Error("missing type");this.type=e,this.mass=n||1,u.call(this,t)}var i=n("./physics"),s=n("./renderer"),o=n("./point-mass"),u=n("./point"),a=n("./rect"),f=n("./body");e.exports=l,l.prototype={createCurtain:function(e,t){var n=6,r=1,i=50,s=25,u=this.width/2-e*n/2;for(var a=0;a<=t;a++)for(var f=0;f<=e;f++){var l=new o(u+f*n,a*n+s);f!=0&&l.attachTo(this.pointMasses[this.pointMasses.length-1],n,r,i),a!=0&&l.attachTo(this.pointMasses[(a-1)*(e+1)+f],n,r,i),a==0&&l.pinTo(l.current.x,l.current.y),l.bounds=this.bounds,this.pointMasses.push(l)}},createBodies:function(e){var t=40;for(var n=0;n<e;n++){var r=Math.random()*this.width,i=Math.random()*this.height,s=new f(r,i,t);s.setBounds(this.bounds),s.addToWorld(this.pointMasses)}},createPuck:function(){var e=new o(this.width/2,this.height/2);e.bounds=this.bounds,this.puck=e,e.applyForce(-1e4,1e4),this.pointMasses.push(e)},createAttractor:function(e){var t=new h("attract",e);t.mass=100+Math.random()*200,this.forces.push(t)},create:function(){this.pointMasses=this.physics.pointMasses=this.renderer.pointMasses=[],this.forces=this.renderer.forces=[],this.form.frame.value=this.physics.frame,this.reversed=this.form.reverse.checked,this.channel.onmessage=function(e){console.log("onmessage",e,this.physics.frame);if(e[0]=="r"){var t=e[1]=="t",n=+e.slice(2),r=this.physics.frame;console.log("reversed %s @%d",t,n),this.physics.reverse(),this.physics.goto(n),this.reversed!=t&&(this.physics.reverse(),this.reversed=this.form.reverse.checked=t),this.physics.reverse(),this.physics.goto(r)}}.bind(this),this.createPuck()},destroy:function(){delete this.forces,delete this.pointMasses,delete this.renderer.forces,delete this.renderer.pointMasses,delete this.physics.pointMasses},controls:function(e){if(this.form.paused.checked)return;this.form.frame.value=this.physics.frame,this.form.speed.value=this.puck.velocity.length,this.form.reverse.checked!=this.reversed&&(this.physics.reverse(),this.host&&this.channel.send("r"+(this.form.reverse.checked?"t":"f")+this.form.frame.value),this.reversed=this.form.reverse.checked),e.mouse.up&&this.createAttractor(e.mouse);for(var t=0;t<this.pointMasses.length;t++){var n=this.pointMasses[t];for(var r=0;r<this.forces.length;r++)this.forces[r].applyForce(n);if(e.mouse.down){var i=e.mouse.clone().sub(n.current);i.length<200}}e.reset()},update:function(e,t){if(this.form.paused.checked)return;this.physics.update(e,t)},render:function(e){this.renderer.clear(),this.renderer.render(e)}},h.prototype={__proto__:u.prototype,applyForce:function(e){if(this.type=="repell"){var t=u.diff(this,e.current),n=t.length;if(n*2<this.mass){var r=this.mass/n;e.applyForce(r*t.x,r*t.y)}}else if(this.type=="attract"){var t=u.diff(this,e.current),n=t.length*2;if(n<this.mass){var r=(1-n/this.mass)*-this.mass;e.applyForce(r*t.x,r*t.y)}}}}}),app=n("app")})();